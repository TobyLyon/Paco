<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Visualizer Toggle Test</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Our scripts -->
    <script src="/crash-casino/frontend/js/crash-chart.js"></script>
    <script src="/crash-casino/frontend/js/crash-rocket.js"></script>
    <script src="/crash-casino/frontend/js/crash-visualizer.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .basically-the-graph {
            width: 100%;
            height: 400px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 2px solid rgba(251, 191, 36, 0.15);
            margin: 20px 0;
            position: relative;
        }
        
        #multiplierChart {
            width: 100% !important;
            height: 100% !important;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        button {
            background: transparent;
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            margin: 0 8px;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: rgba(251, 191, 36, 0.15);
            border-color: #fbbf24;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        
        .game-info-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .test-log {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéÆ Crash Visualizer Toggle Test</h1>
        
        <div class="status">
            <h3>Current Mode: <span id="currentMode">Loading...</span></h3>
            <p>Use the toggle button below to switch between Chart üìà and Rocket üöÄ visualizations</p>
        </div>
        
        <!-- This mimics the structure in pacorocko.html -->
        <div class="basically-the-graph">
            <canvas id="multiplierChart"></canvas>
            <!-- Rocket container will be created dynamically -->
        </div>
        
        <div class="game-info-container">
            <!-- Toggle button will be created here by CrashVisualizer -->
        </div>
        
        <div class="controls">
            <button onclick="startTestRound()">üöÄ Start Test Round</button>
            <button onclick="simulateCrash()">üí• Simulate Crash</button>
            <button onclick="resetVisualization()">üîÑ Reset</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
        
        <div class="test-log" id="testLog">
            <div><strong>Test Log:</strong></div>
        </div>
    </div>

    <script>
        let visualizer = null;
        let testRoundActive = false;
        let testInterval = null;
        let currentMultiplier = 1.0;
        let startTime = null;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('üéÆ Initializing visualizer test...');
            
            // Check if all components loaded
            if (typeof CrashVisualizer === 'undefined') {
                log('‚ùå CrashVisualizer not loaded');
                return;
            }
            
            if (typeof CrashChart === 'undefined') {
                log('‚ö†Ô∏è CrashChart not loaded');
            }
            
            if (typeof CrashRocket === 'undefined') {
                log('‚ö†Ô∏è CrashRocket not loaded');
            }
            
            // Initialize visualizer
            try {
                visualizer = new CrashVisualizer();
                log('‚úÖ Visualizer initialized successfully');
                updateModeDisplay();
            } catch (error) {
                log('‚ùå Failed to initialize visualizer: ' + error.message);
            }
        });
        
        function startTestRound() {
            if (testRoundActive) {
                log('‚ö†Ô∏è Test round already active');
                return;
            }
            
            if (!visualizer) {
                log('‚ùå Visualizer not initialized');
                return;
            }
            
            log('üöÄ Starting test round...');
            testRoundActive = true;
            currentMultiplier = 1.0;
            startTime = Date.now();
            
            // Start the round
            visualizer.startRound();
            
            // Simulate multiplier growth
            testInterval = setInterval(() => {
                if (!testRoundActive) return;
                
                const timeElapsed = (Date.now() - startTime) / 1000;
                
                // Use same formula as real game
                currentMultiplier = 1.0024 * Math.pow(1.0718, timeElapsed);
                
                // Add data point
                visualizer.addDataPoint(timeElapsed, currentMultiplier);
                
                // Auto-crash at random point between 1.5x and 15x
                const crashPoint = 1.5 + Math.random() * 13.5;
                if (currentMultiplier >= crashPoint) {
                    simulateCrash();
                }
                
                // Safety: auto-crash at 30 seconds
                if (timeElapsed > 30) {
                    simulateCrash();
                }
                
            }, 50); // 20 FPS like real game
            
            log(`üìà Test round started - multiplier climbing...`);
        }
        
        function simulateCrash() {
            if (!testRoundActive) return;
            
            testRoundActive = false;
            
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            if (visualizer) {
                visualizer.crashRound(currentMultiplier);
            }
            
            log(`üí• Round crashed at ${currentMultiplier.toFixed(2)}x`);
            
            // Auto-start next round after 3 seconds
            setTimeout(() => {
                if (!testRoundActive) {
                    startTestRound();
                }
            }, 3000);
        }
        
        function resetVisualization() {
            testRoundActive = false;
            
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            if (visualizer) {
                visualizer.reset();
            }
            
            log('üîÑ Visualization reset');
        }
        
        function updateModeDisplay() {
            const modeElement = document.getElementById('currentMode');
            if (modeElement && visualizer) {
                const mode = visualizer.useRocket ? 'Rocket üöÄ' : 'Chart üìà';
                modeElement.textContent = mode;
            }
        }
        
        // Listen for mode changes
        let lastMode = null;
        setInterval(() => {
            if (visualizer && visualizer.useRocket !== lastMode) {
                lastMode = visualizer.useRocket;
                updateModeDisplay();
                log(`üîÑ Mode switched to: ${lastMode ? 'Rocket üöÄ' : 'Chart üìà'}`);
            }
        }, 500);
        
        function log(message) {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            const logElement = document.getElementById('testLog');
            logElement.innerHTML = '<div><strong>Test Log:</strong></div>';
        }
        
        // Auto-start first round after 2 seconds
        setTimeout(() => {
            if (!testRoundActive) {
                startTestRound();
            }
        }, 2000);
    </script>
</body>
</html>
