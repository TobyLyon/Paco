<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PacoRocko - Fixed Server Sync</title>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Fixed Crash Client -->
    <script src="js/fixed-crash-client.js"></script>
    
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .game-display {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .multiplier {
            font-size: 72px;
            font-weight: bold;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .multiplier.running {
            color: #4CAF50;
        }
        
        .multiplier.crashed {
            color: #f44336;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .game-state {
            font-size: 24px;
            margin: 10px 0;
        }
        
        .betting-time {
            font-size: 18px;
            color: #FFD700;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: monospace;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-bet {
            background: #4CAF50;
            color: white;
        }
        
        .btn-bet:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .btn-cashout {
            background: #FFD700;
            color: #000;
        }
        
        .btn-cashout:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }
        
        .history {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .crash-value {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .crash-value.low {
            background: #f44336;
        }
        
        .crash-value.medium {
            background: #FF9800;
        }
        
        .crash-value.high {
            background: #4CAF50;
        }
        
        .bet-input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #444;
            background: #333;
            color: #fff;
            border-radius: 5px;
            width: 150px;
            text-align: center;
            font-family: monospace;
        }
        
        .live-bets {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .bet-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #444;
        }
        
        .log {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            height: 150px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ° PacoRocko - Fixed Server Sync Demo</h1>
        
        <!-- Game Display -->
        <div class="game-display">
            <div class="game-state" id="gameState">Connecting...</div>
            <div class="multiplier" id="multiplier">--.--x</div>
            <div class="betting-time" id="bettingTime"></div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <input type="number" 
                   class="bet-input" 
                   id="betAmount" 
                   value="0.01" 
                   min="0.001" 
                   max="10" 
                   step="0.001">
            <button class="btn btn-bet" id="betButton" disabled>Place Bet</button>
            <button class="btn btn-cashout" id="cashoutButton" disabled>Cash Out</button>
        </div>
        
        <!-- Crash History -->
        <div class="history" id="crashHistory"></div>
        
        <!-- Live Bets -->
        <div class="live-bets">
            <h3>Live Bets</h3>
            <div id="liveBets"></div>
        </div>
        
        <!-- Debug Log -->
        <div class="log" id="debugLog"></div>
    </div>
    
    <script>
        // Debug logging
        function log(message) {
            const logEl = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // Initialize the fixed client
        let client = null;
        let currentBet = null;
        
        window.addEventListener('DOMContentLoaded', () => {
            log('ðŸš€ Initializing Fixed Crash Client...');
            
            // Create client instance
            client = new FixedCrashClient();
            
            // Setup UI callbacks
            client.onMultiplierUpdate = (multiplier, isRunning) => {
                const el = document.getElementById('multiplier');
                el.textContent = multiplier.toFixed(2) + 'x';
                el.className = 'multiplier ' + (isRunning ? 'running' : '');
            };
            
            client.onStateChange = (state) => {
                const stateEl = document.getElementById('gameState');
                const betBtn = document.getElementById('betButton');
                const cashoutBtn = document.getElementById('cashoutButton');
                
                switch (state) {
                    case 'connected':
                        stateEl.textContent = 'Connected - Waiting...';
                        break;
                    case 'betting':
                        stateEl.textContent = 'ðŸŽ² Place Your Bets!';
                        betBtn.disabled = false;
                        cashoutBtn.disabled = true;
                        currentBet = null;
                        break;
                    case 'running':
                        stateEl.textContent = 'ðŸš€ Round in Progress';
                        betBtn.disabled = true;
                        cashoutBtn.disabled = currentBet !== null;
                        break;
                    case 'crashed':
                        stateEl.textContent = 'ðŸ’¥ Crashed!';
                        betBtn.disabled = true;
                        cashoutBtn.disabled = true;
                        document.getElementById('multiplier').classList.add('crashed');
                        setTimeout(() => {
                            document.getElementById('multiplier').classList.remove('crashed');
                        }, 500);
                        break;
                    case 'disconnected':
                        stateEl.textContent = 'âŒ Disconnected';
                        betBtn.disabled = true;
                        cashoutBtn.disabled = true;
                        break;
                }
                
                log(`State: ${state}`);
            };
            
            client.onBettingTimeUpdate = (timeRemaining) => {
                const el = document.getElementById('bettingTime');
                if (timeRemaining > 0) {
                    el.textContent = `Betting closes in: ${timeRemaining.toFixed(1)}s`;
                } else {
                    el.textContent = '';
                }
            };
            
            client.onCrashHistoryUpdate = (history) => {
                const el = document.getElementById('crashHistory');
                el.innerHTML = '';
                
                history.slice(0, 10).forEach(crash => {
                    const div = document.createElement('div');
                    div.className = 'crash-value';
                    div.textContent = crash.toFixed(2) + 'x';
                    
                    if (crash < 2) {
                        div.classList.add('low');
                    } else if (crash < 5) {
                        div.classList.add('medium');
                    } else {
                        div.classList.add('high');
                    }
                    
                    el.appendChild(div);
                });
            };
            
            client.onLiveBetsUpdate = (bets) => {
                const el = document.getElementById('liveBets');
                el.innerHTML = '';
                
                bets.forEach(bet => {
                    const div = document.createElement('div');
                    div.className = 'bet-row';
                    
                    if (bet.b_bet_live) {
                        div.innerHTML = `
                            <span>${bet.the_username}</span>
                            <span>${bet.bet_amount} ETH</span>
                            <span>Betting...</span>
                        `;
                    } else {
                        div.innerHTML = `
                            <span>${bet.the_username}</span>
                            <span>${bet.bet_amount} ETH</span>
                            <span>Won ${bet.cashout_multiplier}x</span>
                        `;
                    }
                    
                    el.appendChild(div);
                });
            };
            
            // Authenticate (mock for demo)
            setTimeout(() => {
                client.socket.emit('authenticate', {
                    address: '0x' + Math.random().toString(16).substr(2, 40),
                    username: 'Player' + Math.floor(Math.random() * 1000)
                });
            }, 1000);
            
            // Setup button handlers
            document.getElementById('betButton').addEventListener('click', async () => {
                const amount = parseFloat(document.getElementById('betAmount').value);
                
                try {
                    log(`Placing bet: ${amount} ETH`);
                    const result = await client.placeBet(amount, 2.0); // Auto cashout at 2x
                    currentBet = result.bet;
                    log(`Bet placed successfully!`);
                } catch (error) {
                    log(`Bet failed: ${error.message}`);
                }
            });
            
            document.getElementById('cashoutButton').addEventListener('click', async () => {
                try {
                    log('Cashing out...');
                    const result = await client.cashOut();
                    log(`Cashed out at ${result.multiplier}x for ${result.total} ETH`);
                    currentBet = null;
                } catch (error) {
                    log(`Cashout failed: ${error.message}`);
                }
            });
        });
    </script>
</body>
</html>
