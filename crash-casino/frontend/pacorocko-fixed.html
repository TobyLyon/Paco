<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PacoRocko - Crash Casino (FIXED SYNC)</title>
    <link rel="stylesheet" href="css/crash-casino.css">
</head>
<body>
    <div id="gameContainer" class="game-container">
        <header class="game-header">
            <h1>🎰 PacoRocko - Fixed Sync</h1>
            <div class="server-status">
                <span id="connectionStatus">🔌 Connecting...</span>
            </div>
        </header>

        <main class="game-main">
            <!-- Multiplier Display -->
            <section class="multiplier-section">
                <div class="multiplier-display">
                    <span id="multiplierValue" class="multiplier-value">1.00x</span>
                </div>
                <div class="game-status">
                    <div id="gameStatus" class="status">Waiting</div>
                    <div id="gameStateMessage" class="message">Connecting to server...</div>
                </div>
            </section>

            <!-- Betting Interface -->
            <section class="betting-section">
                <div class="bet-controls">
                    <div class="bet-input-group">
                        <label for="betAmount">Bet Amount (ETH)</label>
                        <input type="number" id="betAmount" value="0.01" min="0.001" max="1" step="0.001">
                    </div>
                    <div class="bet-input-group">
                        <label for="autoPayoutMultiplier">Auto Cashout</label>
                        <input type="number" id="autoPayoutMultiplier" value="2.0" min="1.01" max="100" step="0.01">
                    </div>
                    <button id="betButton" class="bet-button" disabled>Connect Wallet</button>
                    <button id="cashoutButton" class="cashout-button" disabled>Cash Out</button>
                </div>
            </section>

            <!-- Round History -->
            <section class="history-section">
                <h3>Recent Rounds</h3>
                <div id="roundHistory" class="round-history">
                    <!-- History items will be populated here -->
                </div>
            </section>

            <!-- Chart Section -->
            <section class="chart-section">
                <div id="multiplierChart" class="multiplier-chart">
                    <canvas id="chartCanvas" width="800" height="400"></canvas>
                </div>
            </section>
        </main>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <h2>🎰 PacoRocko Loading...</h2>
            <div class="loading-spinner"></div>
            <p>Implementing single source of truth architecture...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="js/abstract-l2-helper.js"></script>
    <script src="js/wallet-bridge.js"></script>
    <script src="js/sync-controller.js"></script>

    <script>
        /**
         * 🎯 FIXED SYNC IMPLEMENTATION
         * 
         * Single Source of Truth Architecture:
         * - Server: Authoritative for all game logic, timing, crash points
         * - Client: Display only, smooth visual updates, betting interface
         * 
         * NO MORE DUAL SYSTEMS - NO MORE CONFLICTS!
         */
        
        class PacoRockoFixed {
            constructor() {
                this.syncController = null;
                this.walletBridge = null;
                this.isConnected = false;
                this.currentBet = null;
                
                this.init();
            }

            async init() {
                console.log('🎯 Initializing PacoRocko with FIXED sync architecture');
                
                // Hide loading screen after initialization
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 2000);
                
                // Initialize wallet bridge
                this.walletBridge = new WalletBridge();
                await this.walletBridge.init();
                
                // Initialize sync controller (SINGLE SOURCE OF TRUTH)
                this.syncController = new CrashGameSyncController();
                
                // Setup event handlers
                this.setupEventHandlers();
                
                // Connect to server
                await this.syncController.connect();
                
                console.log('✅ PacoRocko initialized with SINGLE SOURCE OF TRUTH');
            }

            setupEventHandlers() {
                // Sync controller events
                this.syncController.onGameStateUpdate = (state) => {
                    this.handleGameStateUpdate(state);
                };

                this.syncController.onRoundStart = (data) => {
                    this.handleRoundStart(data);
                };

                this.syncController.onRoundCrash = (data) => {
                    this.handleRoundCrash(data);
                };

                // Betting interface
                document.getElementById('betButton').addEventListener('click', () => {
                    this.placeBet();
                });

                document.getElementById('cashoutButton').addEventListener('click', () => {
                    this.cashOut();
                });

                // Wallet connection updates
                this.walletBridge.onConnectionChange = (connected) => {
                    this.updateWalletStatus(connected);
                };
            }

            handleGameStateUpdate(state) {
                console.log('🎮 Game state updated:', state);
                
                // Update connection status
                if (state.connected !== undefined) {
                    this.isConnected = state.connected;
                    document.getElementById('connectionStatus').textContent = 
                        state.connected ? '🟢 Connected' : '🔴 Disconnected';
                }
                
                // Update betting interface based on game phase
                if (state.phase === 'betting') {
                    this.enableBetting();
                } else {
                    this.disableBetting();
                }
            }

            handleRoundStart(data) {
                console.log('🚀 Round started:', data);
                
                // Disable betting, enable cashout if player has bet
                this.disableBetting();
                if (this.currentBet) {
                    this.enableCashout();
                }
            }

            handleRoundCrash(data) {
                console.log('💥 Round crashed:', data);
                
                // Reset betting state
                this.currentBet = null;
                this.disableCashout();
                
                // Show crash message
                this.showNotification(`💥 Crashed at ${data.crashPoint.toFixed(2)}x`);
            }

            async placeBet() {
                if (!this.isConnected || !this.walletBridge.isConnected) {
                    this.showNotification('❌ Connect wallet and server first');
                    return;
                }

                const betAmount = parseFloat(document.getElementById('betAmount').value);
                const autoPayoutMultiplier = parseFloat(document.getElementById('autoPayoutMultiplier').value);

                if (betAmount <= 0 || autoPayoutMultiplier <= 1) {
                    this.showNotification('❌ Invalid bet parameters');
                    return;
                }

                try {
                    // Send transaction through wallet bridge
                    const success = await this.walletBridge.sendTransaction(
                        '0x1f8B1c4D05eF17Ebaa1E572426110146691e6C5a', // House wallet
                        betAmount
                    );

                    if (success) {
                        // Place bet through sync controller
                        const betPlaced = this.syncController.placeBet(
                            betAmount,
                            autoPayoutMultiplier,
                            this.walletBridge.address
                        );

                        if (betPlaced) {
                            this.currentBet = { amount: betAmount, autoPayoutMultiplier };
                            this.showNotification(`✅ Bet placed: ${betAmount} ETH @ ${autoPayoutMultiplier}x`);
                        }
                    }
                } catch (error) {
                    console.error('❌ Bet failed:', error);
                    this.showNotification('❌ Bet failed: ' + error.message);
                }
            }

            cashOut() {
                if (!this.currentBet) {
                    this.showNotification('❌ No active bet');
                    return;
                }

                const success = this.syncController.cashOut();
                if (success) {
                    this.showNotification('💸 Cashing out...');
                } else {
                    this.showNotification('❌ Cannot cash out now');
                }
            }

            enableBetting() {
                const betButton = document.getElementById('betButton');
                if (this.walletBridge.isConnected) {
                    betButton.disabled = false;
                    betButton.textContent = 'Place Bet';
                }
            }

            disableBetting() {
                const betButton = document.getElementById('betButton');
                betButton.disabled = true;
                betButton.textContent = 'Round Active';
            }

            enableCashout() {
                const cashoutButton = document.getElementById('cashoutButton');
                cashoutButton.disabled = false;
                cashoutButton.textContent = 'Cash Out';
            }

            disableCashout() {
                const cashoutButton = document.getElementById('cashoutButton');
                cashoutButton.disabled = true;
                cashoutButton.textContent = 'No Bet';
            }

            updateWalletStatus(connected) {
                const betButton = document.getElementById('betButton');
                if (connected) {
                    betButton.textContent = 'Place Bet';
                    if (this.syncController && this.syncController.gamePhase === 'betting') {
                        betButton.disabled = false;
                    }
                } else {
                    betButton.textContent = 'Connect Wallet';
                    betButton.disabled = true;
                }
            }

            showNotification(message) {
                // Simple notification system
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #333;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.pacoRockoFixed = new PacoRockoFixed();
        });

        // Add notification animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            .notification {
                font-family: monospace;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
